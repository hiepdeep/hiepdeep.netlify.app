<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
		<meta content="width=device-width, initial-scale=1" name="viewport">
		<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
		<link rel="icon" href="https://hiepdeep.netlify.app/library/favicon/favicon.ico">
		<title>MakeFujiDirector | HiepDeep</title>
		<style type="text/css">
			body, div, font, html, label, span, table, tbody, td, tfoot, th, thead, tr {
				outline: none;
				vertical-align: baseline;
			}
			:link, button {
				text-decoration: none;
				cursor: pointer;
				user-select: none;
			}
			:link, :hover, :focus, :active, :visited {
				outline: none;
			}
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
				font: 14px "Cambria", sans-serif;
				letter-spacing: 0.05em;
			}
			body {
				background: #edf5f8;
				display: flex;
				flex-direction: column;
				padding: 12px;
				height: 100vh;
			}
			#btnTabs {
				flex-shrink: 0;
				background: white;
				padding: 0 12px;
				height: 50px;
				border: 1px solid #c7cdd1;
				margin-bottom: 12px;
				display: flex;
				justify-content: center;
				align-items: center;
				gap: 12px;
				user-select: none;
			}
			#btnTabs button {
				all: unset;
				cursor: pointer;
			}
			#btnTabs button b {
				font-weight: bold;
				text-decoration: underline;
			}
			#btnTabs .btnNext {
				user-select: none;
				opacity: 0.5;
			}
			#btnTabs .btnImport {
				color: #9fa8da;
			}
			#btnTabs .btnImport:hover {
				text-decoration: underline;
			}
			#btnTabs .btnImport.active {
				color: SlateBlue;
			}
			#btnTabs .btnExport {
				padding: 6px 12px;
				color: SlateBlue;
				border: 1px solid SlateBlue;
				transition: 0.1s;
			}
			#btnTabs .btnExport:hover,
			#btnTabs .btnExport.active {
				background: SlateBlue;
				color: white;
			}
			#ctnTabs {
				height: 100%;
			}
			#ctnTabs .txtImport {
				display: none;
				height: 100%;
			}
			#ctnTabs .txtImport.active {
				display: flex;
				flex-direction: column;
			}
			#ctnTabs .txtImport label[for=addPartUnit] {
				margin-bottom: 12px;
				background: DodgerBlue;
				padding: 12px;
				color: white;
				text-align: center;
				opacity: 0.5;
				transition: 0.1s;
				cursor: pointer;
			}
			#ctnTabs .txtImport label[for=addPartUnit]:hover {
				opacity: 1;
			}
			#ctnTabs .txtImport textarea {
				font: 11px "Consolas", sans-serif;
				width: 100%;
				height: 100%;
				border: 1px solid #c7cdd1;
				border-radius: 0;
				padding: 12px;
				resize: none;
				overflow: scroll;
			}
			#ctnTabs .txtImport #importPartUnit {
				background: white;
				color: #757575;
				font: 11px "Consolas", sans-serif;
				width: 100%;
				height: 100%;
				border: 1px solid #aaa;
				border-radius: 0;
				padding: 12px;
				resize: none;
				overflow: scroll;
				user-select: none;
			}
			.txtExport {
				display: none;
			}
			.txtExport.active {
				display: block;
			}
			.txtExport #export {
				background: white;
				position: absolute;
				top: calc(50px + 12px * 2);
				left: 12px;
				width: calc(100% - 12px * 2);
				height: calc(100% - 50px - 12px * 3);
				overflow: scroll;
				border: 1px solid #c7cdd1;
			}
			.txtExport #export table {
				table-layout: auto;
				width: 100%;
				border-collapse: collapse;
				user-select: all;
			}
			.txtExport #export table tr {
				transition: 0.1s;
			}
			.txtExport #export table tr th,
			.txtExport #export table tr td {
				font: 11px "Consolas", sans-serif;
				padding: 12px;
				color: #444;
				vertical-align: middle;
				text-align: left;
			}
			.txtExport #export table tr th {
				background: #ddd;
				font-weight: bold;
				user-select: none;
			}
			.txtExport #export table tr:nth-child(1):hover {
				background: #ddd;
			}
			.txtExport #export table tr:hover {
				background: #f1f1f1;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<div id="btnTabs">
			<button class="btnImport active">Paste bảng <b>Mark</b></button>
			<span class="btnNext">></span>
			<button class="btnImport">Chọn file <b>PartUnitReport</b> đã lưu</button>
			<span class="btnNext">></span>
			<button class="btnImport">Paste bảng <b>Place</b></button>
			<span class="btnNext">></span>
			<button class="btnExport">Generator</button>
		</div>
		<input type="file" id="addPartUnit" accept="text/xml" data-title="Drag and drop a file" hidden="hidden">
		<div id="ctnTabs">
			<div class="txtImport active">
				<textarea id="importMark" placeholder="Pls add Mark !"></textarea>
			</div>
			<div class="txtImport">
				<label class="addPartUnit" for="addPartUnit">Paste Part Unit</label>
				<div id="importPartUnit">Pls add PartUnit !</div>
			</div>
			<div class="txtImport">
				<textarea id="importPlace" placeholder="Pls add Place !"></textarea>
			</div>
		</div>
		<div class="txtExport">
			<div id="export"></div>
		</div>
		<script type="text/javascript">
			console.clear();
			if (typeof String.prototype.trim !== 'function') {
				String.prototype.trim = function() {
					return this.replace(/^\s+|\s+$/g, '');
				};
			}
			function toggleClass(element, className, add) {
				var currentClass = element.className;
				var hasClass = currentClass.indexOf(className) > -1;
				var regex = new RegExp('(\\s|^)' + className + '(\\s|$)');
				if (add === true && !hasClass) {
					element.className = (currentClass + ' ' + className).trim();
				} else if (add === false && hasClass) {
					element.className = currentClass.replace(regex, ' ').trim();
				}
			}
			function vlookup(key, range, col) {
				for (var i = 0; i < range.length; i++) {
					if (range[i].length > 6 && range[i][6] == key) {
						return range[i][col];
					}
				}
				return "";
			}
			var btnImports = document.getElementsByClassName("btnImport");
			var txtImports = document.getElementsByClassName("txtImport");
			var btnExport = document.getElementsByClassName("btnExport")[0];
			var txtExport = document.getElementsByClassName("txtExport")[0];
			for (var i = 0; i < btnImports.length; i++) {
				(function(index) {
					btnImports[index].addEventListener("click", function() {
						for (var j = 0; j < btnImports.length; j++) {
							toggleClass(btnImports[j], "active", false);
							toggleClass(txtImports[j], "active", false);
						}
						toggleClass(btnExport, "active", false);
						toggleClass(txtExport, "active", false);
						toggleClass(btnImports[index], "active", true);
						toggleClass(txtImports[index], "active", true);
					});
				})(i);
			}
			function formatInput(elementId) {
				console.clear();
				var arr0 = [];
				var arr1 = [];
				var arr2 = [];
				var arr3 = [];
				var inputElement = document.getElementById(elementId);
				var txtInput = inputElement.value.trim().split("\n");
				for (var x = 0; x < txtInput.length; x++) {
					arr0.push([]);
					var cells = txtInput[x].split("\t");
					for (var xx = 0; xx < cells.length; xx++) {
						arr0[x].push(cells[xx].trim());
					}
				}
				if (arr0.length > 0 && arr0[0].length > 0) {
					for (var x = 0; x < arr0[0].length; x++) {
						arr1.push([]);
						arr2.push([]);
						arr3.push([]);
						for (var xx = 0; xx < arr0.length; xx++) {
							var cellValue = arr0[xx][x] || "";
							arr1[x].push(cellValue);
							arr2[x].push(cellValue.length);
						}
						arr3[x].push(Math.max.apply(null, arr2[x]));
						for (var u = 0; u < arr1[x].length; u++) {
							var uLength = arr1[x][u].length;
							var maxLength = arr3[x][0];
							if (uLength < maxLength) {
								for (var k = 0; k < (maxLength - uLength); k++) {
									arr1[x][u] += " ";
								}
							}
						}
					}
					var ee = "";
					for (var x = 0; x < arr1[0].length; x++) {
						for (var xx = 0; xx < arr1.length; xx++) {
							ee += arr1[xx][x];
							if (xx < arr1.length - 1) {
								ee += " | ";
							}
						}
						if (x < arr1[0].length - 1) {
							ee += "\n";
						}
					}
					inputElement.value = ee;
				}
			}
			document.getElementById("importMark").addEventListener("input", function() {
				formatInput("importMark");
			});
			document.getElementById("importPlace").addEventListener("input", function() {
				formatInput("importPlace");
			});
			document.getElementById("addPartUnit").addEventListener("change", function() {
				var read_file = new FileReader();
				var file = document.getElementById("addPartUnit").files[0];
				if (file) {
					read_file.readAsText(file);
				}
				read_file.onload = function() {
					var result = read_file.result.replace(/(\<\?)(.+)(\?\>)/gi, "").trim();
					var importPartUnit = document.getElementById("importPartUnit");
					importPartUnit.style.color = "black";
					importPartUnit.innerHTML = result;
					var arr0 = [];
					var arr1 = [];
					var arr2 = [];
					var arr3 = [];
					var xml_partreportunit = importPartUnit.getElementsByTagName("partreportunit");
					var xml_unit = xml_partreportunit.length > 0 ? xml_partreportunit[0].getElementsByTagName("unit") : [];
					for (var i = 0; i < xml_unit.length; i++) {
						arr0.push([]);
						var children = xml_unit[i].children;
						for (var row = 0; row < children.length; row++) {
							arr0[i].push(children[row].innerText.trim());
						}
					}
					if (arr0.length > 0 && arr0[0].length > 0) {
						for (var x = 0; x < arr0[0].length; x++) {
							arr1.push([]);
							arr2.push([]);
							arr3.push([]);
							for (var xx = 0; xx < arr0.length; xx++) {
								var cellValue = arr0[xx][x] || "";
								arr1[x].push(cellValue);
								arr2[x].push(cellValue.length);
							}
							arr3[x].push(Math.max.apply(null, arr2[x]));
							for (var u = 0; u < arr1[x].length; u++) {
								var uLength = arr1[x][u].length;
								var maxLength = arr3[x][0];
								if (uLength < maxLength) {
									for (var k = 0; k < (maxLength - uLength); k++) {
										arr1[x][u] += "&nbsp;";
									}
								}
							}
						}
						var ee = "";
						for (var x = 0; x < arr1[0].length; x++) {
							for (var xx = 0; xx < arr1.length; xx++) {
								ee += arr1[xx][x];
								if (xx < arr1.length - 1) {
									ee += " | ";
								}
							}
							if (x < arr1[0].length - 1) {
								ee += "<br>";
							}
						}
						importPartUnit.innerHTML = ee.trim();
					} else {
						importPartUnit.innerHTML = "Lỗi: Không tìm thấy dữ liệu PartUnit hợp lệ!";
					}
				};
			});
			btnExport.addEventListener("click", function() {
				console.clear();
				for (var i = 0; i < btnImports.length; i++) {
					toggleClass(btnImports[i], "active", false);
					toggleClass(txtImports[i], "active", false);
				}
				toggleClass(btnExport, "active", true);
				toggleClass(txtExport, "active", true);
				var paste_Mark = document.getElementById("importMark").value.trim();
				var paste_PartUnit = document.getElementById("importPartUnit").innerHTML.trim();
				var paste_Place = document.getElementById("importPlace").value.trim();
				var arr_Mark = [];
				var arr_PartUnit = [];
				var arr_Place = [];
				var row_Mark = [];
				var tempMarkRows = paste_Mark.split("\n");
				for (var x = 0; x < tempMarkRows.length; x++) {
					row_Mark.push([]);
					var cells = tempMarkRows[x].split(" | ");
					for (var xx = 0; xx < cells.length; xx++) {
						row_Mark[x].push(cells[xx].trim());
					}
				}
				var mark_Block = row_Mark[0].indexOf("Board");
				var mark_LocationName = row_Mark[0].indexOf("Ref.");
				var mark_X = row_Mark[0].indexOf("Pos X");
				var mark_Y = row_Mark[0].indexOf("Pos Y");
				arr_Mark.push(["Board", "Location Name", "X", "Y"]);
				for (var row = 1; row < row_Mark.length; row++) {
					arr_Mark.push([]);
					var newRowIndex = arr_Mark.length - 1;
					arr_Mark[newRowIndex].push(row_Mark[row][mark_Block].trim());
					arr_Mark[newRowIndex].push(row_Mark[row][mark_LocationName].trim());
					arr_Mark[newRowIndex].push(row_Mark[row][mark_X].trim());
					arr_Mark[newRowIndex].push(row_Mark[row][mark_Y].trim());
				}
				var row_PartUnit = paste_PartUnit.split("<br>");
				var header_PartUnit = row_PartUnit[0].replace(/(&nbsp;)/g, "").split(" | ");
				var partunit_seqBrdNum = header_PartUnit.indexOf("seqBrdNum");
				var partunit_seqRef = header_PartUnit.indexOf("seqRef");
				var partunit_seqPartNum = header_PartUnit.indexOf("seqPartNum");
				var partunit_fsSetPos = header_PartUnit.indexOf("fsSetPos");
				arr_PartUnit.push(["Board", "Ref.", "Part Number", "Mounter", "Feeder", "BoardRef"]);
				for (var row = 1; row < row_PartUnit.length; row++) {
					if (row_PartUnit[row].search(/\w/g) !== -1) {
						var col_PartUnit = row_PartUnit[row].replace(/(&nbsp;)/g, "").split(" | ");
						if (col_PartUnit.length > partunit_fsSetPos && partunit_fsSetPos !== -1) {
							var fsSetPos_split = col_PartUnit[partunit_fsSetPos].split("-");
							arr_PartUnit.push([]);
							var newRowIndex = arr_PartUnit.length - 1;
							var brdNum = col_PartUnit[partunit_seqBrdNum].trim();
							var ref = col_PartUnit[partunit_seqRef].trim();
							arr_PartUnit[newRowIndex].push(brdNum);
							arr_PartUnit[newRowIndex].push(ref);
							arr_PartUnit[newRowIndex].push(col_PartUnit[partunit_seqPartNum].trim());
							arr_PartUnit[newRowIndex].push(fsSetPos_split[0].trim());
							arr_PartUnit[newRowIndex].push(fsSetPos_split[1].trim());
							arr_PartUnit[newRowIndex].push(brdNum + ref);
						}
					}
				}
				var row_Place = [];
				var tempPlaceRows = paste_Place.split("\n");
				for (var x = 0; x < tempPlaceRows.length; x++) {
					row_Place.push([]);
					var cells = tempPlaceRows[x].split(" | ");
					for (var xx = 0; xx < cells.length; xx++) {
						row_Place[x].push(cells[xx].trim());
					}
				}
				var place_Board = row_Place[0].indexOf("Board");
				var place_Ref = row_Place[0].indexOf("Ref.");
				var place_PosX = row_Place[0].indexOf("Pos X");
				var place_PosY = row_Place[0].indexOf("Pos Y");
				var place_Rotation = row_Place[0].indexOf("Rotation");
				var place_PartNumber = row_Place[0].indexOf("Part Number");
				arr_Place.push(["Board", "Ref.", "Pos X", "Pos Y", "Rotation", "Part Number", "BoardRef"]);
				for (var row = 1; row < row_Place.length; row++) {
					arr_Place.push([]);
					var newRowIndex = arr_Place.length - 1;
					var brd = row_Place[row][place_Board].trim();
					var ref = row_Place[row][place_Ref].trim();
					arr_Place[newRowIndex].push(brd);
					arr_Place[newRowIndex].push(ref);
					arr_Place[newRowIndex].push(row_Place[row][place_PosX].trim());
					arr_Place[newRowIndex].push(row_Place[row][place_PosY].trim());
					arr_Place[newRowIndex].push(row_Place[row][place_Rotation].trim());
					arr_Place[newRowIndex].push(row_Place[row][place_PartNumber].trim());
					arr_Place[newRowIndex].push(brd + ref);
				}
				var generator = "";
				generator += "<tr>";
				generator += "<th>Board</th>";
				generator += "<th>Ref.</th>";
				generator += "<th>Pos X</th>";
				generator += "<th>Pos Y</th>";
				generator += "<th>Rotation</th>";
				generator += "<th>Part Number</th>";
				generator += "<th>Mouter</th>";
				generator += "<th>Feeder</th>";
				generator += "</tr>";
				for (var tr_Mark = 1; tr_Mark < arr_Mark.length; tr_Mark++) {
					if (arr_Mark[tr_Mark][0] == "0") {
						var locationName = arr_Mark[tr_Mark][1];
						var lastChar = locationName.charAt(locationName.length - 1);
						generator += "<tr>";
						generator += "<td>" + arr_Mark[tr_Mark][0] + "</td>";
						generator += "<td>MARK" + lastChar + "</td>";
						generator += "<td>" + arr_Mark[tr_Mark][2] + "</td>";
						generator += "<td>" + arr_Mark[tr_Mark][3] + "</td>";
						generator += "<td>0</td>";
						generator += "<td>Mark</td>";
						generator += "<td>0</td>";
						generator += "<td>0</td>";
						generator += "</tr>";
					}
				}
				var ref_PartUnit = 5;
				for (var tr_PartUnit = 1; tr_PartUnit < arr_PartUnit.length; tr_PartUnit++) {
					var boardRefKey = arr_PartUnit[tr_PartUnit][ref_PartUnit];
					var board = vlookup(boardRefKey, arr_Place, 0);
					var ref = vlookup(boardRefKey, arr_Place, 1);
					var posX = vlookup(boardRefKey, arr_Place, 2);
					var posY = vlookup(boardRefKey, arr_Place, 3);
					var rotation = vlookup(boardRefKey, arr_Place, 4);
					var partNumber = vlookup(boardRefKey, arr_Place, 5);
					var mounter = arr_PartUnit[tr_PartUnit][3];
					var feeder = arr_PartUnit[tr_PartUnit][4];
					if (board && ref) {
						generator += "<tr>";
						generator += "<td>" + board.trim() + "</td>";
						generator += "<td>" + ref.trim() + "</td>";
						generator += "<td>" + posX.trim() + "</td>";
						generator += "<td>" + posY.trim() + "</td>";
						generator += "<td>" + rotation.trim() + "</td>";
						generator += "<td>" + partNumber.trim() + "</td>";
						generator += "<td>M" + mounter.trim() + "</td>";
						generator += "<td>F" + feeder.trim() + "</td>";
						generator += "</tr>";
					}
				}
				document.getElementById("export").innerHTML = "<table>" + generator + "</table>";
			});
		</script>
	</body>
</html>